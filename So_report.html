<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VIP 투자자 일일 분석 보고서</title>
    <style>
        body {
            font-family: 'Malgun Gothic', 'Apple SD Gothic Neo', sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 20px;
            background-color: #ecf0f1;
            /* Cool grey background for professional look */
            color: #2c3e50;
        }

        .container {
            max-width: 1100px;
            margin: 0 auto;
            background-color: white;
            padding: 50px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
            position: relative;
        }

        /* Header Section */
        header {
            border-bottom: 4px solid #2c3e50;
            padding-bottom: 20px;
            margin-bottom: 40px;
            text-align: center;
        }

        h1 {
            color: #2c3e50;
            font-size: 36px;
            margin: 0;
            letter-spacing: -1px;
        }

        .report-date {
            font-size: 18px;
            color: #7f8c8d;
            margin-top: 10px;
            font-weight: bold;
        }

        /* Section Styling */
        h2 {
            color: #2980b9;
            font-size: 26px;
            margin-top: 50px;
            margin-bottom: 20px;
            border-left: 6px solid #e74c3c;
            padding-left: 15px;
            background: linear-gradient(to right, #f9f9f9, #fff);
            padding-top: 5px;
            padding-bottom: 5px;
        }

        /* Executive Summary Box */
        .exec-summary {
            background-color: #2c3e50;
            color: white;
            padding: 25px;
            border-radius: 5px;
            font-size: 20px;
            font-weight: bold;
            text-align: center;
            margin-bottom: 40px;
            border: 2px solid #34495e;
        }

        .exec-summary span {
            display: block;
            font-size: 24px;
            color: #f1c40f;
            /* Gold for emphasis */
            margin-top: 10px;
        }

        /* Tables */
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            font-size: 18px;
        }

        th,
        td {
            padding: 12px;
            text-align: center;
            border-bottom: 1px solid #bdc3c7;
        }

        th {
            background-color: #ecf0f1;
            color: #2c3e50;
            font-weight: 800;
        }

        .up {
            color: #c0392b;
            font-weight: bold;
        }

        /* Red for up */
        .down {
            color: #2980b9;
            font-weight: bold;
        }

        /* Blue for down */
        .neutral {
            color: #7f8c8d;
        }

        /* Action Plan Box */
        .action-plan {
            background-color: #fff3e0;
            /* Light orange */
            border: 2px solid #e67e22;
            padding: 30px;
            border-radius: 5px;
            font-size: 20px;
            font-weight: bold;
            color: #d35400;
        }

        .action-plan ul {
            list-style-type: none;
            padding: 0;
        }

        .action-plan li {
            margin-bottom: 15px;
            padding-left: 30px;
            position: relative;
        }

        .action-plan li::before {
            content: "✅";
            position: absolute;
            left: 0;
        }

        /* Risk Warning Footer */
        .footer-warning {
            margin-top: 60px;
            padding: 20px;
            background-color: #abb7b7;
            color: #2c3e50;
            font-size: 16px;
            text-align: center;
            border-radius: 5px;
            font-style: italic;
        }

        /* Metaphor Tip Box */
        .metaphor-box {
            background-color: #e8f6f3;
            border-left: 5px solid #1abc9c;
            padding: 15px;
            margin: 10px 0;
            font-size: 16px;
        }

        .note-item {
            background-color: white;
            padding: 10px;
            margin-bottom: 8px;
            border-radius: 4px;
            border-left: 4px solid #34495e;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
            font-size: 14px;
        }

        .note-time {
            font-size: 11px;
            color: #7f8c8d;
            margin-bottom: 3px;
            display: block;
            font-weight: bold;
        }

        /* Real-time data animations */
        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.3;
            }
        }

        @keyframes blink {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }
        }

        .price-up {
            color: #e74c3c !important;
            animation: blink 0.5s;
        }

        .price-down {
            color: #3498db !important;
            animation: blink 0.5s;
        }
    </style>
</head>

<body>

    <div class="container">
        <header>
            <h1>VIP 투자 전략 보고서</h1>
            <div class="report-date" id="report-timestamp">
                생성 일시:
                <script>document.write(new Date().toLocaleString('ko-KR', { year: 'numeric', month: 'long', day: 'numeric', weekday: 'short', hour: '2-digit', minute: '2-digit' }));</script>
                | 데이터: 실시간 연동
            </div>
        </header>

        <!-- Analyst Input Section -->
        <div class="analyst-input-section"
            style="margin-bottom: 40px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 25px; border-radius: 12px; box-shadow: 0 8px 20px rgba(0,0,0,0.15);">
            <h3
                style="margin: 0 0 15px 0; color: white; font-size: 22px; display: flex; align-items: center; gap: 10px;">
                <span style="font-size: 28px;">🎯</span>
                <span>추가 의견 입력 (Report Override)</span>
            </h3>
            <div style="background: rgba(255,255,255,0.95); padding: 15px; border-radius: 8px;">
                <div style="display: flex; gap: 12px; align-items: stretch;">
                    <textarea id="note-input" rows="3"
                        style="flex: 1; padding: 12px; border: 2px solid #667eea; border-radius: 6px; font-size: 15px; resize: vertical;"
                        placeholder="💡 분석 의견을 입력하세요 (예: '현재 과열, 즉시 매도', '추가 상승 여력, 적극 매수')&#10;&#10;입력 후 '분석 반영' 클릭 시 보고서 전체가 귀하의 의견에 맞춰 재작성됩니다."></textarea>
                    <button id="add-note-btn"
                        style="width: 140px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; font-size: 16px; box-shadow: 0 4px 10px rgba(102,126,234,0.3); transition: all 0.3s;"
                        onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 15px rgba(102,126,234,0.4)';"
                        onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 10px rgba(102,126,234,0.3)';">분석
                        반영<br><span style="font-size: 12px; font-weight: normal;">Apply</span></button>
                </div>
                <div id="note-list" style="display: none;">
                    <!-- Notes saved but hidden -->
                </div>
            </div>
        </div>

        <!-- Real-Time Yahoo Finance Data -->
        <div class="live-market-section"
            style="margin-bottom: 30px; background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%); padding: 25px; border-radius: 12px; box-shadow: 0 8px 20px rgba(0,0,0,0.2);">
            <h2 style="margin: 0 0 20px 0; color: white; display: flex; align-items: center; gap: 10px;">
                <span
                    style="display: inline-block; width: 12px; height: 12px; background: #e74c3c; border-radius: 50%; animation: pulse 2s infinite;"></span>
                실시간 시장 현황 (Yahoo Finance)
            </h2>

            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 20px;">
                <!-- KOSPI Live -->
                <div id="kospi-live" style="background: rgba(255,255,255,0.1); padding: 20px; border-radius: 8px;">
                    <div style="color: rgba(255,255,255,0.7); font-size: 14px; margin-bottom: 5px;">KOSPI (^KS11)</div>
                    <div style="font-size: 32px; font-weight: bold; color: white; margin-bottom: 10px;">로딩 중...</div>
                    <div style="font-size: 14px; color: rgba(255,255,255,0.8);">변동률: -</div>
                    <div style="font-size: 12px; color: rgba(255,255,255,0.6); margin-top: 8px;">거래량: -</div>
                </div>

                <!-- KOSDAQ Live -->
                <div id="kosdaq-live" style="background: rgba(255,255,255,0.1); padding: 20px; border-radius: 8px;">
                    <div style="color: rgba(255,255,255,0.7); font-size: 14px; margin-bottom: 5px;">KOSDAQ (^KQ11)</div>
                    <div style="font-size: 32px; font-weight: bold; color: white; margin-bottom: 10px;">로딩 중...</div>
                    <div style="font-size: 14px; color: rgba(255,255,255,0.8);">변동률: -</div>
                    <div style="font-size: 12px; color: rgba(255,255,255,0.6); margin-top: 8px;">거래량: -</div>
                </div>

                <!-- S&P 500 Live -->
                <div id="sp500-live" style="background: rgba(255,255,255,0.1); padding: 20px; border-radius: 8px;">
                    <div style="color: rgba(255,255,255,0.7); font-size: 14px; margin-bottom: 5px;">S&P 500 (^GSPC)
                    </div>
                    <div style="font-size: 32px; font-weight: bold; color: white; margin-bottom: 10px;">로딩 중...</div>
                    <div style="font-size: 14px; color: rgba(255,255,255,0.8);">변동률: -</div>
                    <div style="font-size: 12px; color: rgba(255,255,255,0.6); margin-top: 8px;">거래량: -</div>
                </div>

                <!-- Nasdaq Composite Live -->
                <div id="nasdaq-live" style="background: rgba(255,255,255,0.1); padding: 20px; border-radius: 8px;">
                    <div style="color: rgba(255,255,255,0.7); font-size: 14px; margin-bottom: 5px;">Nasdaq (^IXIC)</div>
                    <div style="font-size: 32px; font-weight: bold; color: white; margin-bottom: 10px;">로딩 중...</div>
                    <div style="font-size: 14px; color: rgba(255,255,255,0.8);">변동률: -</div>
                    <div style="font-size: 12px; color: rgba(255,255,255,0.6); margin-top: 8px;">거래량: -</div>
                </div>

                <!-- Dow Jones Live -->
                <div id="dowjones-live" style="background: rgba(255,255,255,0.1); padding: 20px; border-radius: 8px;">
                    <div style="color: rgba(255,255,255,0.7); font-size: 14px; margin-bottom: 5px;">Dow Jones (^DJI)
                    </div>
                    <div style="font-size: 32px; font-weight: bold; color: white; margin-bottom: 10px;">로딩 중...</div>
                    <div style="font-size: 14px; color: rgba(255,255,255,0.8);">변동률: -</div>
                    <div style="font-size: 12px; color: rgba(255,255,255,0.6); margin-top: 8px;">거래량: -</div>
                </div>

                <!-- Apple Live -->
                <div id="apple-live" style="background: rgba(255,255,255,0.1); padding: 20px; border-radius: 8px;">
                    <div style="color: rgba(255,255,255,0.7); font-size: 14px; margin-bottom: 5px;">Apple (AAPL)</div>
                    <div style="font-size: 32px; font-weight: bold; color: white; margin-bottom: 10px;">로딩 중...</div>
                    <div style="font-size: 14px; color: rgba(255,255,255,0.8);">변동률: -</div>
                    <div style="font-size: 12px; color: rgba(255,255,255,0.6); margin-top: 8px;">거래량: -</div>
                </div>
            </div>

            <div style="text-align: right; color: rgba(255,255,255,0.6); font-size: 12px;">
                마지막 업데이트: <span id="update-time">-</span> | 10초마다 자동 갱신
            </div>
        </div>

        <!-- Executive Summary -->
        <div class="exec-summary">
            <div style="text-align: left;">
                <strong style="font-size: 1.3em;">[투자 전략 - 2026.02.02 레버리지 적극 투자]</strong><br><br>

                <span style="font-size: 1.1em; line-height: 1.8;">
                    <strong style="color: #27ae60;">🚀 투자 성향 분석:</strong><br>
                    충분한 <strong>현금 보유</strong>로 리스크 관리 기반이 확보되어 있으므로, <strong>레버리지 ETF를 활용한 적극적 수익 추구 전략</strong>이
                    가능합니다.
                    현재 시장은 변동성이 확대되는 국면이나, 이는 <strong>레버리지 트레이딩에 최적의 환경</strong>입니다.
                </span><br><br>

                <strong style="color: #f39c12;">🎯 핵심 기회 요인:</strong><br>
                <span style="font-size: 1.05em; line-height: 1.7;">
                    • <strong>KOSPI 상승 모멘텀</strong>: 기술적 지지선 돌파 후 추가 상승 여력 확인<br>
                    • <strong>외국인 순매수 전환 가능성</strong>: 환율 안정 시 대규모 자금 유입 예상<br>
                    • <strong>변동성 확대</strong>: 레버리지 2배 효과로 수익률 극대화 기회
                </span><br><br>

                <strong style="color: #e74c3c;">⚡ 즉각 실행 전략:</strong><br>
                <div
                    style="background: rgba(255,255,255,0.1); padding: 15px; margin-top: 10px; border-radius: 5px; border-left: 4px solid #27ae60;">
                    <span style="font-size: 1.1em;">
                        1. <strong>레버리지 ETF 비중 70-80% 유지</strong> (대부분 포지션)<br>
                        2. <strong>3-5일 단기 트레이딩</strong> (복리 왜곡 최소화)<br>
                        3. <strong>+15% 익절 / -10% 손절</strong> 기준 엄수<br>
                        4. <strong>매일 장 종료 30분 전 리밸런싱</strong> (모멘텀 최적화)
                    </span>
                </div>
            </div>
        </div>

        <!-- 1. Real-Time Market Dashboard -->
        <h2>1. 글로벌 및 국내 증시 현황 (실시간)</h2>
        <!-- Ticker Tape -->
        <div class="tradingview-widget-container" style="height: 70px; margin-bottom: 20px;">
            <div class="tradingview-widget-container__widget"></div>
            <script type="text/javascript"
                src="https://s3.tradingview.com/external-embedding/embed-widget-ticker-tape.js" async>
                    {
                        "symbols": [
                            { "proName": "KRX:KOSPI", "title": "KOSPI" },
                            { "proName": "KRX:KOSDAQ", "title": "KOSDAQ" },
                            { "proName": "CME_MINI:NQ1!", "title": "Nasdaq 100 선물" },
                            { "proName": "FOREXCOM:SPXUSD", "title": "S&P 500" },
                            { "proName": "FX_IDC:USDKRW", "title": "원/달러" }
                        ],
                            "showSymbolLogo": true,
                                "isTransparent": false,
                                    "displayMode": "adaptive",
                                        "colorTheme": "light",
                                            "locale": "kr"
                    }
                </script>
        </div>

        <!-- Mini Charts -->
        <div style="display: flex; gap: 10px; justify-content: space-between;">
            <!-- KODEX 200 Leverage -->
            <div style="flex: 1;">
                <div class="tradingview-widget-container">
                    <script type="text/javascript"
                        src="https://s3.tradingview.com/external-embedding/embed-widget-mini-symbol-overview.js" async>
                            {
                                "symbol": "KRX:122630",
                                    "width": "100%",
                                        "height": 220,
                                            "locale": "kr",
                                                "dateRange": "12M",
                                                    "colorTheme": "light",
                                                        "isTransparent": false,
                                                            "autosize": false,
                                                                "largeChartUrl": ""
                            }
                        </script>
                </div>
                <p style="text-align: center; font-weight: bold; color: #2c3e50;">KODEX 200 레버리지</p>
            </div>
            <!-- KODEX KOSDAQ 150 Lev -->
            <div style="flex: 1;">
                <div class="tradingview-widget-container">
                    <script type="text/javascript"
                        src="https://s3.tradingview.com/external-embedding/embed-widget-mini-symbol-overview.js" async>
                            {
                                "symbol": "KRX:233740",
                                    "width": "100%",
                                        "height": 220,
                                            "locale": "kr",
                                                "dateRange": "12M",
                                                    "colorTheme": "light",
                                                        "isTransparent": false,
                                                            "autosize": false,
                                                                "largeChartUrl": ""
                            }
                        </script>
                </div>
                <p style="text-align: center; font-weight: bold; color: #2c3e50;">KODEX 코스닥150 레버리지</p>
            </div>
        </div>

        <!-- 2. Market Dynamics -->
        <h2>2. 시장 동력 및 뉴스 요약 (Fact Check)</h2>
        <div style="background-color: #f9f9f9; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
            <p style="font-size: 16px; line-height: 1.8; color: #2c3e50;">
                <strong>📌 시장 분석 요약:</strong> 2월 초 현재 국내 증시는 강력한 상승 모멘텀과 동시에 조정 압력이 공존하는 복합적 국면에 진입하였습니다.
                미국의 통화정책 불확실성, 원화 약세 지속, 그리고 실물 경기의 점진적 회복세가 교차하며 단기 변동성 확대가 예상됩니다.
                특히 레버리지 상품 투자자들은 <strong>음의 복리 효과</strong>와 <strong>급격한 시장 반전 리스크</strong>를 반드시 고려해야 합니다.
            </p>
        </div>
        <table>
            <thead>
                <tr>
                    <th width="20%">구분/일자</th>
                    <th>핵심 내용 및 영향 분석 (출처)</th>
                    <th width="15%">영향도</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td><strong>미 연준 이슈</strong><br><small>26.01.30</small></td>
                    <td style="text-align: left;">
                        <strong>'케빈 워시' 의장 지명:</strong> 트럼프 대통령이 차기 연준 의장으로 공식 지명 했습니다.<br>
                        → 매파적(긴축) 성향 인물로, 금리 인하 기대감 축소 및 달러 강세 유발.<br>
                        <span style="color:#7f8c8d; font-size: 0.8em;">(출처: CNBC, Truth Social)</span>
                    </td>
                    <td class="down">부정적</td>
                </tr>
                <tr>
                    <td><strong>환율 동향</strong><br><small>실시간</small></td>
                    <td style="text-align: left;">
                        <strong>원/달러 1,450원선:</strong> 외국인 투자자에게 환차손 우려를 주는 심리적 저항선.<br>
                        → 외국인 순매수 전환 확인 전까지 대형주 상승 제한.<br>
                        <span style="color:#7f8c8d; font-size: 0.8em;">(출처: Investing.com)</span>
                    </td>
                    <td><span style="color: #e67e22; font-weight: bold;">주의</span></td>
                </tr>
                <tr>
                    <td><strong>실물 경기</strong><br><small>26.02.02</small></td>
                    <td style="text-align: left;">
                        <strong>한국 제조 PMI 호조 (51.2):</strong> 5개월 만에 최고치 기록, 경기 반등 신호.<br>
                        → 반도체 및 수출 관련주 하방 경직성 확보에 긍정적.<br>
                        <span style="color:#7f8c8d; font-size: 0.8em;">(출처: S&P Global)</span>
                    </td>
                    <td class="up">긍정적</td>
                </tr>
                <tr>
                    <td><strong>원자재 급락</strong><br><small>26.01.31</small></td>
                    <td style="text-align: left;">
                        <strong>금값 급락 (-11%):</strong> 단기 차익 실현 및 강달러 영향으로 온스당 $4,745 수준 하락.<br>
                        → 위험 자산(주식) 선호 심리 재확인 가능성.<br>
                        <span style="color:#7f8c8d; font-size: 0.8em;">(출처: LA Times, GoldInvest)</span>
                    </td>
                    <td class="neutral">중립</td>
                </tr>
            </tbody>
        </table>

        <!-- 3. Technical Analysis -->
        <h2>3. 기술적 지표 및 쉬운 해석</h2>
        <div style="display: flex; gap: 20px; align-items: flex-start;">
            <!-- Gauge Widget -->
            <div style="width: 350px;">
                <div class="tradingview-widget-container">
                    <script type="text/javascript"
                        src="https://s3.tradingview.com/external-embedding/embed-widget-technical-analysis.js" async>
                            {
                                "interval": "1D",
                                    "width": 350,
                                        "isTransparent": false,
                                            "height": 350,
                                                "symbol": "KRX:KOSPI",
                                                    "showIntervalTabs": false,
                                                        "displayMode": "single",
                                                            "locale": "kr",
                                                                "colorTheme": "light"
                            }
                        </script>
                </div>
            </div>
            <!-- Explanation Table -->
            <div style="flex: 1;">
                <h3>🎯 6. 시나리오별 행동 지침</h3>
                <table>
                    <tr>
                        <th>시장 시나리오</th>
                        <th>대응 전략</th>
                        <th>레버리지 비중 조정</th>
                    </tr>
                    <tr style="background-color: #ffebee;">
                        <td><strong>📈 강세 지속 (+3% 이상)</strong></td>
                        <td>
                            • 레버리지 포지션 <strong>80%까지 확대</strong><br>
                            • KOSDAQ150 레버리지 비중 증액<br>
                            • 매일 오후 2:30 수익률 점검 후 익절 판단
                        </td>
                        <td style="color: #27ae60; font-weight: bold;">75% → 80%</td>
                    </tr>
                    <tr>
                        <td><strong>📊 박스권 등락 (±1%)</strong></td>
                        <td>
                            • <strong>데이 트레이딩</strong> 전환 (장중 3회 이상 매매)<br>
                            • 지지선/저항선 매매 전략<br>
                            • 하단 매수 → 상단 매도 반복
                        </td>
                        <td style="color: #3498db; font-weight: bold;">60-70% 유지</td>
                    </tr>
                    <tr style="background-color: #e8f5e9;">
                        <td><strong>📉 조정 발생 (-2% 이상)</strong></td>
                        <td>
                            • 레버리지 50% 즉시 청산<br>
                            • 현금 확보 후 <strong>-5% 도달 시 저점 매수</strong><br>
                            • 개별주 → 레버리지 ETF 순차 전환
                        </td>
                        <td style="color: #e74c3c; font-weight: bold;">75% → 40%</td>
                    </tr>
                    <tr style="background-color: #fff9e6;">
                        <td><strong>⚠️ 급락 (-5% 이상)</strong></td>
                        <td>
                            • <strong>레버리지 전량 청산</strong> (손실 확정)<br>
                            • 현금 비중 90% 이상 확보<br>
                            • 반등 시그널 확인 후 재진입 (RSI 30 이하)
                        </td>
                        <td style="color: #e74c3c; font-weight: bold;">75% → 0%</td>
                    </tr>
                </table>

                <div
                    style="background-color: #e3f2fd; padding: 15px; border-radius: 8px; margin: 15px 0; border-left: 4px solid #2196f3;">
                    <strong style="color: #1976d2; font-size: 17px;">💡 레버리지 트레이딩 핵심 원칙</strong>
                    <p style="font-size: 15px; line-height: 1.8; margin-top: 10px; color: #2c3e50;">
                        1. <strong>"빠른 결단"</strong>: 수익이든 손실이든 목표 도달 시 즉시 청산<br>
                        2. <strong>"분할 진입"</strong>: 한 번에 몰빵 금지, 30%씩 3회 분할 매수<br>
                        3. <strong>"감정 배제"</strong>: 알람 설정 후 기계적 실행 (±10% 알람 필수)<br>
                        4. <strong>"타이밍 중시"</strong>: 장 시작 30분, 장 마감 30분 집중 모니터링<br>
                        5. <strong>"손실 제한"</strong>: 일일 계좌 손실 -15% 도달 시 당일 거래 중단
                    </p>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>지표명</th>
                            <th>현재 상태 (비유)</th>
                            <th>해석</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><strong>RSI</strong><br>(상대강도지수)</td>
                            <td><span style="font-size: 24px;">🌡️</span><br><strong>"엔진 과열"</strong> (70↑)</td>
                            <td>단기간에 너무 빨리 달렸습니다. 잠시 엔진을 식히는(조정) 구간이 필연적입니다.</td>
                        </tr>
                        <tr>
                            <td><strong>볼린저밴드</strong></td>
                            <td><span style="font-size: 24px;">📏</span><br><strong>"고무줄 팽팽"</strong> (상단)</td>
                            <td>고무줄을 최대로 당기면 튕겨 나가거나 끊어집니다. 추가 상승보다 되돌림 확률이 높습니다.</td>
                        </tr>
                        <tr>
                            <td><strong>이동평균선</strong></td>
                            <td><span style="font-size: 24px;">🎢</span><br><strong>"오르막길"</strong> (정배열)</td>
                            <td>아직 추세 자체는 무너지지 않았습니다. 급락 시 20일선(생명선) 지지 여부가 관건입니다.</td>
                        </tr>
                    </tbody>
                </table>
                <div
                    style="margin-top: 20px; background-color: #fff9e6; padding: 15px; border-radius: 5px; border: 1px solid #f39c12;">
                    <strong style="color: #d35400; font-size: 16px;">🔍 지표 활용 가이드:</strong>
                    <ul style="margin: 10px 0; padding-left: 20px; line-height: 1.8;">
                        <li><strong>RSI 70 돌파 시:</strong> 추가 매수를 <u>즉시 중단</u>하고 기존 포지션의 30% 이상 익절 실시</li>
                        <li><strong>볼린저밴드 상단 이탈:</strong> 통계적으로 3~5일 내 되돌림 확률 70% 이상, 단기 차익실현 타이밍</li>
                        <li><strong>이동평균선 정배열 유지:</strong> 추세 자체는 건재하므로 과도한 공포 매도는 지양, 다만 20일선 이탈 시 <u>절반 이상 매도</u> 필수
                        </li>
                        <li><strong>종합 판단:</strong> 현재는 상승 추세 말기 ~ 조정 초기 사이의 전환점. <strong>욕심보다는 방어</strong>가 우선</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- 4. Portfolio & Action Plan -->
        <h2>4. 포트폴리오 관리 및 액션 플랜</h2>

        <div class="metaphor-box">
            <strong>💡 투자 조언 (비유로 이해하기):</strong><br>
            "비가 올 것 같으면 우산을 미리 준비하십시오. 지금은 현금이라는 우산을 챙길 때입니다."<br>
            <span style="font-size: 14px; color: #7f8c8d; margin-top: 5px; display: block;">
                → 시장이 무너진 후에는 '현금'을 확보하고 싶어도 가격이 급락하여 손실이 확정됩니다.
                <h3 style="margin-top: 30px;">📊 5. 레버리지 적극 포트폴리오 전략</h3>
                <table>
                    <tr>
                        <th>자산 분류</th>
                        <th>권장 비중</th>
                        <th>주요 종목</th>
                        <th>전략 근거</th>
                    </tr>
                    <tr>
                        <td><strong>레버리지 ETF</strong></td>
                        <td style="font-size: 1.3em; color: #27ae60; font-weight: bold;">75%</td>
                        <td>KODEX 200×2, KOSDAQ150×2</td>
                        <td>현금 보유량이 충분하므로 고수익 추구 가능</td>
                    </tr>
                    <tr>
                        <td><strong>현금</strong></td>
                        <td style="font-size: 1.3em; color: #3498db; font-weight: bold;">15%</td>
                        <td>MMF, 단기 예금</td>
                        <td>급격한 하락 시 추가 매수 자금</td>
                    </tr>
                    <tr>
                        <td><strong>개별 수급주</strong></td>
                        <td style="font-size: 1.3em; font-weight: bold;">10%</td>
                        <td>반도체, 2차전지</td>
                        <td>자산군 분산 및 테마 플레이</td>
                    </tr>
                </table>

                <div
                    style="background-color: #e8f5e9; padding: 15px; border-radius: 8px; margin: 15px 0; border-left: 4px solid #27ae60;">
                    <strong style="color: #27ae60; font-size: 17px;">🚀 레버리지 운용 핵심 원칙</strong>
                    <p style="font-size: 15px; line-height: 1.8; margin-top: 10px; color: #2c3e50;">
                        • <strong>KODEX 200 레버리지 (50%)</strong>: 대형주 중심, 안정적 베이스 포지션<br>
                        • <strong>KODEX KOSDAQ150 레버리지 (25%)</strong>: 기술주 중심, 고변동성 고수익 추구<br>
                        • <strong>보유 기간</strong>: 3-5영업일 (복리 왜곡 최소화)<br>
                        • <strong>익절/손절 기준</strong>: +15% 도달 시 50% 익절, -10% 도달 시 즉시 전량 손절<br>
                        • <strong>리밸런싱</strong>: 매일 장 종료 30분 전 수익률 확인 후 조정<br>
                        • <strong>경고</strong>: 레버리지는 <u>일일 수익률 2배 추종</u> 구조, 장기 보유 시 복리 효과 왜곡 발생
                    </p>
                </div>

                <div
                    style="background-color: #fff9e6; padding: 15px; border-radius: 8px; margin: 15px 0; border-left: 4px solid #f39c12;">
                    <strong style="color: #d35400; font-size: 17px;">⚡ 리스크 관리 항상 규칙</strong>
                    <p style="font-size: 15px; line-height: 1.8; margin-top: 10px; color: #2c3e50;">
                        1. <strong>레버리지 총액 제한</strong>: 보유 현금의 <u>3배 이내</u>로 제한 (극단적 손실 방지)<br>
                        2. <strong>분할 매도 원칙</strong>: 큰 변동 예상 시 30%씩 3회 분할 매도<br>
                        3. <strong>심리적 한계</strong>: 하루 수익률 -5% 돌파 시 당일 거래 중단<br>
                        4. <strong>주말/공휴일 전 청산</strong>: 주말 가격 급변 리스크 회피
                    </p>
                </div>

                <div class="action-plan">
                    [시나리오별 대응 매뉴얼]
                    <ul>
                        <li><strong>🔻 개별 종목 -7% 하락 시:</strong><br>
                            &nbsp;&nbsp;&nbsp;→ 이유 불문 <strong>"묻지마 절반 매도"</strong> 하십시오. 손실을 끊어내는 것이 고수의 첫 걸음입니다.</li>
                        <li><strong>🔻 계좌 전체 -10% 손실 시:</strong><br>
                            &nbsp;&nbsp;&nbsp;→ 시장이 틀린 것이 아니라 내가 틀린 것입니다. <strong>전량 현금화</strong> 후 여행을 다녀오십시오.</li>
                        <li><strong>🔺 내일 2% 추가 하락 시:</strong><br>
                            &nbsp;&nbsp;&nbsp;→ '저가 매수' 기회가 아닙니다. '떨어지는 칼날'입니다. 매수 버튼에서 손을 떼십시오.</li>
                    </ul>
                </div>

                <div class="footer-warning">
                    ⚠️ <strong>레버리지의 함정:</strong> 레버리지 상품의 '음의 복리 효과'는 <strong>"가랑비에 옷 젖는 것"</strong>과 같습니다.
                    횡보장에서도 내 돈은 매일 조금씩 녹아 없어집니다. 장기 투자는 절대 금물입니다.
                </div>

        </div>

        <script>
            // Enhanced Analyst Input Logic to Comprehensively Rewrite Report
            const noteList = document.getElementById('note-list');
            const noteInput = document.getElementById('note-input');
            const addBtn = document.getElementById('add-note-btn');
            const execSummaryBox = document.querySelector('.exec-summary');
            const actionPlanBox = document.querySelector('.action-plan');

            // Load notes from LocalStorage
            function loadNotes() {
                const notes = JSON.parse(localStorage.getItem('vip_investor_notes') || '[]');
                noteList.innerHTML = '';
                notes.forEach(note => {
                    addNoteElement(note.text, note.time);
                });

                // Re-apply the latest note to the report view if it exists
                if (notes.length > 0) {
                    updateReportView(notes[notes.length - 1].text);
                }
            }

            // Add Note to DOM
            function addNoteElement(text, time) {
                const div = document.createElement('div');
                div.className = 'note-item';
                div.innerHTML = `<span class="note-time">${time}</span>${text.replace(/\n/g, '<br>')}`;
                noteList.prepend(div);
            }

            // Comprehensive Report Rewrite based on Input
            // Gemini API Integration via Cloudflare Workers
            const WORKER_URL = 'https://gemini-report-analyzer.ykkim-182.workers.dev';

            // Collect current market data
            function collectMarketData() {
                const getPrice = (id) => {
                    const el = document.getElementById(id);
                    if (!el) return 'N/A';
                    const text = el.textContent;
                    return text.match(/[\d,]+\.[\d]+/)?.[0] || 'N/A';
                };

                const getChange = (id) => {
                    const el = document.getElementById(id);
                    if (!el) return 'N/A';
                    const text = el.textContent;
                    return text.match(/[+-]?[\d.]+%/)?.[0] || 'N/A';
                };

                return {
                    kospi: { price: getPrice('kospi-live'), change: getChange('kospi-live') },
                    kosdaq: { price: getPrice('kosdaq-live'), change: getChange('kosdaq-live') },
                    kodex200: { price: getPrice('kodex200-live') },
                    kodex150: { price: getPrice('kodex150-live') },
                    sp500: { price: getPrice('sp500-live') },
                    nasdaq: { price: getPrice('nasdaq-live') }
                };
            }

            // Call Gemini API via Cloudflare Workers
            async function callGeminiAPI(userInput, marketData) {
                const response = await fetch(WORKER_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ userInput, marketData })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || `HTTP ${response.status}`);
                }

                const data = await response.json();
                if (!data.success) {
                    throw new Error(data.error || '알 수 없는 오류');
                }

                return data.report;
            }

            // Parse Gemini response and update HTML
            function updateReportWithAI(aiReport) {
                // Simple markdown to HTML conversion
                const parseMarkdown = (text) => {
                    return text
                        .replace(/\n/g, '<br>')
                        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                        .replace(/\*(.*?)\*/g, '<em>$1</em>');
                };

                // Update Executive Summary
                const execSummary = document.querySelector('.exec-summary');
                if (execSummary) {
                    const summaryMatch = aiReport.match(/EXECUTIVE_SUMMARY([\s\S]*?)(?=PORTFOLIO_STRATEGY|$)/);
                    if (summaryMatch) {
                        execSummary.innerHTML = `
                        <div style="text-align: left; position: relative;">
                            <div style="position: absolute; top: 10px; right: 10px; background: #27ae60; color: white; padding: 5px 10px; border-radius: 5px; font-size: 12px;">
                                🤖 AI 분석
                            </div>
                            ${parseMarkdown(summaryMatch[1].trim())}
                        </div>
                    `;
                        execSummary.style.backgroundColor = '#e8f5e9';
                        setTimeout(() => { execSummary.style.backgroundColor = ''; }, 2000);
                    }
                }

                // Add Portfolio Strategy as a new section
                const portfolioMatch = aiReport.match(/PORTFOLIO_STRATEGY([\s\S]*?)(?=ACTION_PLAN|$)/);
                if (portfolioMatch) {
                    const existingAI = document.querySelector('.ai-portfolio-section');
                    if (existingAI) existingAI.remove();

                    const aiSection = document.createElement('div');
                    aiSection.className = 'ai-portfolio-section';
                    aiSection.style.cssText = 'background: #fff3e0; padding: 20px; border-radius: 8px; margin: 20px 0; border-left: 4px solid #ff9800;';
                    aiSection.innerHTML = `
                    <strong style="color: #e65100; font-size: 18px;">🤖 AI 맞춤형 포트폴리오 전략</strong>
                    <div style="margin-top: 10px;">
                        ${parseMarkdown(portfolioMatch[1].trim())}
                    </div>
                `;

                    const portfolioHeading = Array.from(document.querySelectorAll('h3')).find(
                        h3 => h3.textContent.includes('포트폴리오')
                    );
                    if (portfolioHeading) {
                        portfolioHeading.parentElement.insertBefore(aiSection, portfolioHeading.nextSibling);
                    }
                }

                // Add Action Plan
                const actionMatch = aiReport.match(/ACTION_PLAN([\s\S]*)/);
                if (actionMatch) {
                    const existingAI = document.querySelector('.ai-action-section');
                    if (existingAI) existingAI.remove();

                    const aiSection = document.createElement('div');
                    aiSection.className = 'ai-action-section';
                    aiSection.style.cssText = 'background: #e3f2fd; padding: 20px; border-radius: 8px; margin: 20px 0; border-left: 4px solid #2196f3;';
                    aiSection.innerHTML = `
                    <strong style="color: #1976d2; font-size: 18px;">🤖 AI 시나리오 분석</strong>
                    <div style="margin-top: 10px;">
                        ${parseMarkdown(actionMatch[1].trim())}
                    </div>
                `;

                    const scenarioHeading = Array.from(document.querySelectorAll('h3')).find(
                        h3 => h3.textContent.includes('시나리오')
                    );
                    if (scenarioHeading) {
                        scenarioHeading.parentElement.insertBefore(aiSection, scenarioHeading.nextSibling);
                    }
                }
            }

            // Original simple sentiment analysis (fallback)
            function updateReportView(text) {
                const lowerText = text.toLowerCase();
                let sentiment = "neutral";
                let confidence = "보통";

                // Enhanced keyword analysis
                const bullishKeywords = ["매수", "긍정", "상승", "기회", "돌파", "강세", "반등", "호재", "추천"];
                const bearishKeywords = ["매도", "현금", "위험", "폭락", "관망", "조정", "하락", "악재", "경계", "청산"];

                const bullishCount = bullishKeywords.filter(k => text.includes(k)).length;
                const bearishCount = bearishKeywords.filter(k => text.includes(k)).length;

                if (bullishCount > bearishCount && bullishCount > 0) {
                    sentiment = "bullish";
                    confidence = bullishCount >= 2 ? "강력" : "보통";
                } else if (bearishCount > bullishCount && bearishCount > 0) {
                    sentiment = "bearish";
                    confidence = bearishCount >= 2 ? "강력" : "보통";
                }

                // === 1. REWRITE EXECUTIVE SUMMARY ===
                if (sentiment === "bearish") {
                    execSummaryBox.innerHTML = `
                    <div style="text-align: left;">
                        <strong style="font-size: 1.2em;">[긴급 투자 전략 수정 - ${confidence} 위험 신호]</strong><br><br>
                        <span style="color: #fff; font-size: 1.1em;">⛔ 분석가 긴급 의견:</span><br>
                        <div style="background: rgba(255,255,255,0.1); padding: 15px; margin: 10px 0; border-radius: 5px; font-weight: normal;">
                            "${text}"
                        </div>
                        <strong style="color: #ffeb3b;">📍 즉각 실행 지침:</strong><br>
                        • 모든 레버리지 포지션 <strong>50% 이상 즉시 청산</strong>하십시오<br>
                        • 현금 비중을 <strong>최소 50%</strong>로 증액하십시오<br>
                        • 추가 하락 시 <strong>전량 현금화</strong> 준비를 하십시오
                    </div>
                `;
                    execSummaryBox.style.backgroundColor = "#c0392b";
                    execSummaryBox.style.border = "3px solid #e74c3c";

                } else if (sentiment === "bullish") {
                    execSummaryBox.innerHTML = `
                    <div style="text-align: left;">
                        <strong style="font-size: 1.2em;">[긴급 투자 전략 수정 - ${confidence} 매수 기회]</strong><br><br>
                        <span style="color: #fff; font-size: 1.1em;">🚀 분석가 긴급 의견:</span><br>
                        <div style="background: rgba(255,255,255,0.1); padding: 15px; margin: 10px 0; border-radius: 5px; font-weight: normal;">
                            "${text}"
                        </div>
                        <strong style="color: #f1c40f;">📍 즉각 실행 지침:</strong><br>
                        • 현금 비중을 <strong>30% 수준으로 조정</strong>하고 주식 비중 확대<br>
                        • KODEX 레버리지 상품 <strong>분할 매수</strong> 검토<br>
                        • 단, 손절라인 <strong>-7% 엄수</strong> (상승장에서도 리스크 관리 필수)
                    </div>
                `;
                    execSummaryBox.style.backgroundColor = "#27ae60";
                    execSummaryBox.style.border = "3px solid #2ecc71";

                } else {
                    // Neutral - keep default detailed summary without adding analyst comment
                    execSummaryBox.innerHTML = `
                    <div style="text-align: left;">
                        <strong style="font-size: 1.3em;">[종합 결론 - 2026.02.02 시장 분석]</strong><br><br>
                        
                        <span style="font-size: 1.1em; line-height: 1.8;">
                            <strong style="color: #f39c12;">⚠️ 현재 시장 진단:</strong><br>
                            국내 증시는 <strong>과열권 진입 직전 단계</strong>에 있습니다. KOSPI는 단기 급등 이후 기술적 저항선에 도달하였으며, 레버리지 ETF의 거래량 급증은 개인 투자자들의 과도한 낙관론을 시사합니다.
                        </span><br><br>
                        
                        <strong style="color: #f1c40f;">📊 핵심 리스크 요인:</strong><br>
                        <span style="font-size: 1.05em; line-height: 1.7;">
                            • <strong>미 연준 매파 인사 지명</strong>으로 금리 인하 기대 후퇴<br>
                            • <strong>원/달러 1,450원선</strong> 고착화로 외국인 수급 부담<br>
                            • <strong>기술적 과열 신호</strong> (RSI 70 근접, 볼린저밴드 상단 이탈)
                        </span><br><br>
                        
                        <strong style="color: #f1c40f;">� 즉각 실행 지침:</strong><br>
                        <div style="background: rgba(255,255,255,0.1); padding: 15px; margin-top: 10px; border-radius: 5px; border-left: 4px solid #f1c40f;">
                            <span style="font-size: 1.1em;">
                                1. <strong>현금 비중 30% 이상 확보</strong> (필수)<br>
                                2. <strong>레버리지 포지션 절반 이상 청산</strong> 권고<br>
                                3. <strong>손절라인 -7% 엄수</strong> (예외 없음)<br>
                                4. <strong>신규 매수 자제</strong>, 기존 포지션 관리에 집중
                            </span>
                        </div>
                    </div>
                `;
                    execSummaryBox.style.backgroundColor = "#2c3e50";
                    execSummaryBox.style.border = "2px solid #34495e";
                }

                // === 2. REWRITE PORTFOLIO STRATEGY TABLE ===
                const portfolioTable = document.querySelector('table[style*="font-size: 20px"]');
                if (portfolioTable) {
                    let stockRatio, cashRatio, rationale;

                    if (sentiment === "bearish") {
                        stockRatio = confidence === "강력" ? "30%" : "40%";
                        cashRatio = confidence === "강력" ? "70%" : "60%";
                        rationale = "시장 위험 증가로 인한 방어적 포지션 전환";
                    } else if (sentiment === "bullish") {
                        stockRatio = confidence === "강력" ? "80%" : "70%";
                        cashRatio = confidence === "강력" ? "20%" : "30%";
                        rationale = "상승 모멘텀 확인으로 공격적 포지션 전환";
                    } else {
                        stockRatio = "70%";
                        cashRatio = "30%";
                        rationale = "중립 시장 대응 균형 포지션 유지";
                    }

                    portfolioTable.innerHTML = `
                    <tr>
                        <td style="background-color: #fce4ec; width: 30%; font-weight: bold;">수정 포트폴리오 비중</td>
                        <td style="text-align: left; padding-left: 30px;">
                            🔴 주식(ETF): <strong style="font-size: 1.3em; color: ${sentiment === 'bullish' ? '#27ae60' : sentiment === 'bearish' ? '#c0392b' : '#2c3e50'};">${stockRatio}</strong><br>
                            💰 현금: <strong style="font-size: 1.3em; color: ${sentiment === 'bearish' ? '#27ae60' : sentiment === 'bullish' ? '#e67e22' : '#2c3e50'};">${cashRatio}</strong>
                            <div style="margin-top: 8px; font-size: 0.8em; color: #7f8c8d;">
                                (조정 근거: ${rationale})
                            </div>
                        </td>
                    </tr>
                `;
                }

                // === 3. REWRITE ACTION PLAN ===
                const actionUl = actionPlanBox.querySelector('ul');
                if (actionUl) {
                    if (sentiment === "bearish") {
                        actionUl.innerHTML = `
                        <li><strong>🚨 즉시 실행 (긴급):</strong><br>
                            &nbsp;&nbsp;&nbsp;→ 레버리지 ETF <strong>50% 이상 매도</strong> (익절/손절 무관)<br>
                            &nbsp;&nbsp;&nbsp;→ 현금 비중 <strong>${cashRatio}</strong>까지 즉시 증액<br>
                            &nbsp;&nbsp;&nbsp;→ 추가 하락 시 나머지 포지션도 <strong>무조건 청산</strong></li>
                        <li><strong>🔻 손절 기준 강화:</strong><br>
                            &nbsp;&nbsp;&nbsp;→ 개별 종목 <strong>-5%</strong> 도달 시 즉시 전량 매도 (기존 -7% 대비 강화)<br>
                            &nbsp;&nbsp;&nbsp;→ 시장이 귀하의 예상과 다르게 움직이면 <strong>잘못을 인정</strong>하고 빠르게 철수하십시오</li>
                        <li><strong>⏸️ 신규 매수 금지:</strong><br>
                            &nbsp;&nbsp;&nbsp;→ 모든 '저가 매수' 시그널을 <strong>무시</strong>하십시오<br>
                            &nbsp;&nbsp;&nbsp;→ 떨어지는 칼날을 잡으려 하지 마십시오</li>
                    `;
                        actionPlanBox.style.backgroundColor = "#ffcdd2";
                        actionPlanBox.style.borderColor = "#c62828";
                        actionPlanBox.style.borderWidth = "3px";

                    } else if (sentiment === "bullish") {
                        actionUl.innerHTML = `
                        <li><strong>🚀 적극 매수 전략:</strong><br>
                            &nbsp;&nbsp;&nbsp;→ 현금 비중을 <strong>${cashRatio}</strong>까지 축소, 주식 비중 <strong>${stockRatio}</strong> 확대<br>
                            &nbsp;&nbsp;&nbsp;→ KODEX 200/KOSDAQ150 레버리지 <strong>2~3회 분할 매수</strong><br>
                            &nbsp;&nbsp;&nbsp;→ 단, 한 번에 몰빵하지 말고 <strong>시간 분산 필수</strong></li>
                        <li><strong>⚠️ 상승장 리스크 관리:</strong><br>
                            &nbsp;&nbsp;&nbsp;→ 손절라인 <strong>-7%</strong>는 여전히 엄수 (과욕 금물)<br>
                            &nbsp;&nbsp;&nbsp;→ 급등 시 <strong>일부 익절</strong>로 원금 회수 전략 병행</li>
                        <li><strong>📊 기술적 지표 모니터링:</strong><br>
                            &nbsp;&nbsp;&nbsp;→ RSI 70 이상 진입 시 <strong>추가 매수 중단</strong><br>
                            &nbsp;&nbsp;&nbsp;→ 20일 이평선 이탈 시 <strong>절반 이상 즉시 매도</strong></li>
                    `;
                        actionPlanBox.style.backgroundColor = "#c8e6c9";
                        actionPlanBox.style.borderColor = "#2e7d32";
                        actionPlanBox.style.borderWidth = "3px";

                    } else {
                        actionUl.innerHTML = `
                        <li><strong>🔻 개별 종목 -7% 하락 시:</strong><br>
                            &nbsp;&nbsp;&nbsp;→ 이유 불문 <strong>"묻지마 절반 매도"</strong> 하십시오. 손실을 끊어내는 것이 고수의 첫 걸음입니다.</li>
                        <li><strong>🔻 계좌 전체 -10% 손실 시:</strong><br>
                            &nbsp;&nbsp;&nbsp;→ 시장이 틀린 것이 아니라 내가 틀린 것입니다. <strong>전량 현금화</strong> 후 여행을 다녀오십시오.</li>
                        <li><strong>🔺 내일 2% 추가 하락 시:</strong><br>
                            &nbsp;&nbsp;&nbsp;→ '저가 매수' 기회가 아닙니다. '떨어지는 칼날'입니다. 매수 버튼에서 손을 떼십시오.</li>
                    `;
                        actionPlanBox.style.backgroundColor = "#fff3e0";
                        actionPlanBox.style.borderColor = "#e67e22";
                        actionPlanBox.style.borderWidth = "2px";
                    }
                }

                // Visual feedback
                document.body.style.transition = "background-color 0.5s";
                const originalBg = document.body.style.backgroundColor;
                document.body.style.backgroundColor = sentiment === "bearish" ? "#ffe6e6" : sentiment === "bullish" ? "#e6f7e6" : "#f0f0f0";
                setTimeout(() => {
                    document.body.style.backgroundColor = "#ecf0f1";
                }, 2000);
            }

            // Save Note & Update Report
            addBtn.addEventListener('click', () => {
                const text = noteInput.value.trim();
                if (!text) {
                    alert("분석 내용을 먼저 입력해주세요.");
                    return;
                }

                const now = new Date().toLocaleString('ko-KR', { month: 'numeric', day: 'numeric', hour: '2-digit', minute: '2-digit' });
                const notes = JSON.parse(localStorage.getItem('vip_investor_notes') || '[]');

                notes.push({ text: text, time: now });
                localStorage.setItem('vip_investor_notes', JSON.stringify(notes));

                addNoteElement(text, now);
                updateReportView(text); // Trigger comprehensive rewrite

                noteInput.value = '';

                // Enhanced feedback
                alert("✅ 보고서가 귀하의 분석 의견에 따라 전면 재작성되었습니다.\n\n변경된 내용:\n• 종합 결론\n• 포트폴리오 비중\n• 시나리오별 행동 지침");
            });

            // Initialize
            loadNotes();
        </script>

        <script>
            // Yahoo Finance Real-Time Data Integration
            let previousPrices = { kospi: null, kosdaq: null };

            async function fetchYahooFinance(symbol) {
                try {
                    const url = `https://query1.finance.yahoo.com/v8/finance/chart/${symbol}?interval=1m&range=1d`;
                    const response = await fetch(url);

                    if (!response.ok) {
                        throw new Error('Yahoo Finance API error');
                    }

                    const data = await response.json();
                    return data.chart.result[0];
                } catch (error) {
                    console.error('Error fetching Yahoo Finance data:', error);
                    return null;
                }
            }

            function formatNumber(num) {
                if (!num) return '-';
                return num.toLocaleString('ko-KR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            }

            function formatVolume(vol) {
                if (!vol) return '-';
                return (vol / 1000000).toFixed(1) + 'M';
            }

            async function updateStockPrice(symbol, elementId, indexName) {
                const data = await fetchYahooFinance(symbol);
                const element = document.getElementById(elementId);

                if (!data || !element) {
                    element.querySelector('div:nth-child(2)').innerHTML = '데이터 로드 실패';
                    return;
                }

                try {
                    const quote = data.meta;
                    const currentPrice = quote.regularMarketPrice;
                    const previousClose = quote.chartPreviousClose;
                    const change = currentPrice - previousClose;
                    const changePercent = (change / previousClose) * 100;
                    const volume = data.timestamp ? data.indicators.quote[0].volume[data.indicators.quote[0].volume.length - 1] : 0;

                    // Determine color based on change
                    const changeColor = change >= 0 ? '#e74c3c' : '#3498db';
                    const changeSymbol = change >= 0 ? '▲' : '▼';
                    const changeClass = change >= 0 ? 'price-up' : 'price-down';

                    // Check if price changed for animation
                    const priceKey = indexName.toLowerCase();
                    const priceChanged = previousPrices[priceKey] !== null && previousPrices[priceKey] !== currentPrice;
                    previousPrices[priceKey] = currentPrice;

                    // Update DOM
                    element.innerHTML = `
                    <div style="color: rgba(255,255,255,0.7); font-size: 14px; margin-bottom: 5px;">${indexName} (${symbol})</div>
                    <div class="${priceChanged ? changeClass : ''}" style="font-size: 32px; font-weight: bold; color: white; margin-bottom: 10px;">
                        ${formatNumber(currentPrice)}
                    </div>
                    <div style="font-size: 14px; color: ${changeColor}; font-weight: bold;">
                        ${changeSymbol} ${formatNumber(Math.abs(change))} (${changePercent >= 0 ? '+' : ''}${changePercent.toFixed(2)}%)
                    </div>
                    <div style="font-size: 12px; color: rgba(255,255,255,0.6); margin-top: 8px;">
                        거래량: ${formatVolume(volume)}
                    </div>
                `;

                    // Update timestamp
                    const now = new Date();
                    document.getElementById('update-time').textContent = now.toLocaleTimeString('ko-KR');

                } catch (error) {
                    console.error('Error parsing data:', error);
                    element.querySelector('div:nth-child(2)').innerHTML = '파싱 오류';
                }
            }

            async function updateAllPrices() {
                await Promise.all([
                    updateStockPrice('^KS11', 'kospi-live', 'KOSPI'),
                    updateStockPrice('^KQ11', 'kosdaq-live', 'KOSDAQ'),
                    updateStockPrice('122630.KS', 'kodex200-live', 'KODEX 200 레버리지'),
                    updateStockPrice('233740.KS', 'kodex150-live', 'KODEX KOSDAQ150 레버리지'),
                    updateStockPrice('ES=F', 'sp500-live', 'S&P 500 선물'),
                    updateStockPrice('NQ=F', 'nasdaq-live', 'Nasdaq 선물')
                ]);
            }

            // Initial load
            updateAllPrices();

            // Auto-refresh every 10 seconds
            setInterval(updateAllPrices, 10000);

            // Pause updates when page is not visible
            let updateInterval;
            document.addEventListener('visibilitychange', function () {
                if (document.hidden) {
                    clearInterval(updateInterval);
                } else {
                    updateAllPrices();
                    updateInterval = setInterval(updateAllPrices, 10000);
                }
            });
        </script>

        <!-- Gemini API Integration Script -->
        <script>
            // ========================================
            // Gemini API Integration via Cloudflare Workers
            // ========================================

            const GEMINI_WORKER_URL = 'https://gemini-report-analyzer.ykkim-182.workers.dev';

            // Collect current market data from the page
            function collectMarketData() {
                const getPrice = (id) => {
                    const el = document.getElementById(id);
                    if (!el) return 'N/A';
                    const text = el.textContent;
                    return text.match(/[\d,]+\.[\d]+/)?.[0] || 'N/A';
                };

                const getChange = (id) => {
                    const el = document.getElementById(id);
                    if (!el) return 'N/A';
                    const text = el.textContent;
                    return text.match(/[+-]?[\d.]+%/)?.[0] || 'N/A';
                };

                return {
                    kospi: { price: getPrice('kospi-live'), change: getChange('kospi-live') },
                    kosdaq: { price: getPrice('kosdaq-live'), change: getChange('kosdaq-live') },
                    kodex200: { price: getPrice('kodex200-live') },
                    kodex150: { price: getPrice('kodex150-live') },
                    sp500: { price: getPrice('sp500-live') },
                    nasdaq: { price: getPrice('nasdaq-live') }
                };
            }

            // Call Gemini API via Cloudflare Workers
            async function callGeminiAPI(userInput, marketData) {
                console.log('🤖 Calling Gemini API...', { userInput, marketData });

                const response = await fetch(GEMINI_WORKER_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ userInput, marketData })
                });

                console.log('📡 Response status:', response.status);

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('❌ API Error:', errorText);
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }

                const data = await response.json();
                console.log('✅ API Response:', data);

                if (!data.success) {
                    throw new Error(data.error || '알 수 없는 오류');
                }

                return data.report;
            }

            // Update HTML with AI-generated report
            function updateReportWithAI(aiReport) {
                console.log('📝 Updating report with AI analysis...');

                // Simple markdown to HTML conversion
                const parseMarkdown = (text) => {
                    return text
                        .replace(/\n/g, '<br>')
                        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                        .replace(/\*(.*?)\*/g, '<em>$1</em>');
                };

                // 1. Update Executive Summary
                const execSummary = document.querySelector('.exec-summary');
                if (execSummary) {
                    const summaryMatch = aiReport.match(/EXECUTIVE_SUMMARY([\s\S]*?)(?=PORTFOLIO_STRATEGY|$)/);
                    if (summaryMatch) {
                        execSummary.innerHTML = `
                    <div style="text-align: left; position: relative;">
                        <div style="position: absolute; top: 10px; right: 10px; background: #27ae60; color: white; padding: 5px 10px; border-radius: 5px; font-size: 12px; font-weight: bold; z-index: 10;">
                            🤖 AI 분석
                        </div>
                        ${parseMarkdown(summaryMatch[1].trim())}
                    </div>
                `;
                        execSummary.style.backgroundColor = '#e8f5e9';
                        setTimeout(() => { execSummary.style.backgroundColor = ''; }, 2000);
                        console.log('✅ Executive summary updated');
                    }
                }

                // 2. Add Portfolio Strategy Section
                const portfolioMatch = aiReport.match(/PORTFOLIO_STRATEGY([\s\S]*?)(?=ACTION_PLAN|$)/);
                if (portfolioMatch) {
                    // Remove existing AI section if any
                    const existingAI = document.querySelector('.ai-portfolio-section');
                    if (existingAI) existingAI.remove();

                    const aiSection = document.createElement('div');
                    aiSection.className = 'ai-portfolio-section';
                    aiSection.style.cssText = 'background: #fff3e0; padding: 20px; border-radius: 8px; margin: 20px 0; border-left: 4px solid #ff9800; box-shadow: 0 4px 6px rgba(0,0,0,0.1);';
                    aiSection.innerHTML = `
                <strong style="color: #e65100; font-size: 18px;">🤖 AI 맞춤형 포트폴리오 전략</strong>
                <div style="margin-top: 10px; line-height: 1.8;">
                    ${parseMarkdown(portfolioMatch[1].trim())}
                </div>
            `;

                    const portfolioHeading = Array.from(document.querySelectorAll('h3')).find(
                        h3 => h3.textContent.includes('포트폴리오')
                    );
                    if (portfolioHeading) {
                        portfolioHeading.parentElement.insertBefore(aiSection, portfolioHeading.nextSibling);
                        console.log('✅ Portfolio section added');
                    }
                }

                // 3. Add Action Plan Section
                const actionMatch = aiReport.match(/ACTION_PLAN([\s\S]*)/);
                if (actionMatch) {
                    // Remove existing AI section if any
                    const existingAI = document.querySelector('.ai-action-section');
                    if (existingAI) existingAI.remove();

                    const aiSection = document.createElement('div');
                    aiSection.className = 'ai-action-section';
                    aiSection.style.cssText = 'background: #e3f2fd; padding: 20px; border-radius: 8px; margin: 20px 0; border-left: 4px solid #2196f3; box-shadow: 0 4px 6px rgba(0,0,0,0.1);';
                    aiSection.innerHTML = `
                <strong style="color: #1976d2; font-size: 18px;">🤖 AI 시나리오 분석</strong>
                <div style="margin-top: 10px; line-height: 1.8;">
                    ${parseMarkdown(actionMatch[1].trim())}
                </div>
            `;

                    const scenarioHeading = Array.from(document.querySelectorAll('h3')).find(
                        h3 => h3.textContent.includes('시나리오')
                    );
                    if (scenarioHeading) {
                        scenarioHeading.parentElement.insertBefore(aiSection, scenarioHeading.nextSibling);
                        console.log('✅ Action plan section added');
                    }
                }

                console.log('🎉 Report update complete!');
            }

            // Initialize Gemini integration on page load
            window.addEventListener('DOMContentLoaded', () => {
                const addBtn = document.getElementById('add-note-btn');
                const noteInput = document.getElementById('note-input');

                if (!addBtn || !noteInput) {
                    console.error('❌ Required elements not found');
                    return;
                }

                // Remove existing event listeners by cloning the button
                const newAddBtn = addBtn.cloneNode(true);
                addBtn.parentNode.replaceChild(newAddBtn, addBtn);

                // Add new Gemini-powered event listener
                newAddBtn.addEventListener('click', async () => {
                    const text = noteInput.value.trim();
                    if (!text) {
                        alert("분석 내용을 먼저 입력해주세요.");
                        return;
                    }

                    // Loading state
                    newAddBtn.disabled = true;
                    const originalHTML = newAddBtn.innerHTML;
                    newAddBtn.innerHTML = '🔄 AI 분석 중...<br><span style="font-size: 12px;">30-60초 소요</span>';
                    newAddBtn.style.opacity = '0.6';

                    try {
                        // Collect market data
                        const marketData = collectMarketData();
                        console.log('📊 Market data collected:', marketData);

                        // Call Gemini API
                        const aiReport = await callGeminiAPI(text, marketData);
                        console.log('📄 AI Report received, length:', aiReport.length);

                        // Update report with AI analysis
                        updateReportWithAI(aiReport);

                        // Save to localStorage
                        const now = new Date().toLocaleString('ko-KR', { month: 'numeric', day: 'numeric', hour: '2-digit', minute: '2-digit' });
                        const notes = JSON.parse(localStorage.getItem('vip_investor_notes') || '[]');
                        notes.push({ text: text, time: now, aiReport: aiReport });
                        localStorage.setItem('vip_investor_notes', JSON.stringify(notes));

                        noteInput.value = '';

                        // Success message
                        alert("✅ AI 분석 완료!\n\n보고서가 귀하의 요청에 맞춰 재작성되었습니다.\n\n추가된 섹션:\n• 종합 결론 (🤖 AI 분석 배지)\n• 🤖 AI 맞춤형 포트폴리오 전략\n• 🤖 AI 시나리오 분석\n\n페이지를 스크롤하여 확인하세요!");

                    } catch (error) {
                        console.error('❌ Gemini API Error:', error);
                        alert(`❌ AI 분석 중 오류가 발생했습니다.\n\n오류: ${error.message}\n\n• F12를 눌러 Console 확인\n• Cloudflare Workers 설정 확인\n• API 키가 올바른지 확인`);
                    } finally {
                        // Restore button
                        newAddBtn.disabled = false;
                        newAddBtn.innerHTML = originalHTML;
                        newAddBtn.style.opacity = '1';
                    }
                });

                console.log('✅ Gemini API integration loaded successfully!');
                console.log('📡 Worker URL:', GEMINI_WORKER_URL);
            });
        </script>

        <!-- 실시간 시황 요약 섹션 추가 스크립트 -->
        <script>
            // 실시간 시황 요약 생성 및 삽입
            function initMarketSummary() {
                // 종합 결론 섹션 찾기
                const sections = document.querySelectorAll('section');
                let targetSection = null;

                sections.forEach(section => {
                    const h3 = section.querySelector('h3');
                    if (h3 && h3.textContent.includes('종합 결론')) {
                        targetSection = section;
                    }
                });

                if (!targetSection) {
                    console.error('❌ 종합 결론 섹션을 찾을 수 없습니다.');
                    return;
                }

                // 시황 요약 HTML 생성
                const summaryHTML = `
        <div id="market-summary-live" style="
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            padding: 24px;
            border-radius: 16px;
            margin-bottom: 24px;
            box-shadow: 0 8px 24px rgba(30, 60, 114, 0.3);
            font-family: -apple-system, BlinkMacSystemFont, 'Apple SD Gothic Neo', 'Noto Sans KR', sans-serif;
        ">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; flex-wrap: wrap;">
                <h3 style="margin: 0; font-size: 22px; font-weight: 600; letter-spacing: -0.5px;">
                    📊 실시간 종합 시황
                </h3>
                <div id="update-time" style="
                    font-size: 13px;
                    background: rgba(255,255,255,0.2);
                    padding: 6px 12px;
                    border-radius: 6px;
                    font-weight: 500;
                "></div>
            </div>
            <div id="market-summary-content" style="
                background: rgba(255,255,255,0.1);
                padding: 20px;
                border-radius: 12px;
                line-height: 1.9;
                font-size: 16px;
                backdrop-filter: blur(10px);
            ">
                <div style="text-align: center; padding: 20px; color: rgba(255,255,255,0.7);">
                    시장 데이터 로딩 중...
                </div>
            </div>
        </div>
    `;

                // 종합 결론 h3 태그 바로 뒤에 삽입
                const h3 = targetSection.querySelector('h3');
                if (h3) {
                    h3.insertAdjacentHTML('afterend', summaryHTML);
                    console.log('✅ 시황 요약 섹션 삽입 완료');
                }
            }

            // 시황 요약 업데이트 함수
            function updateMarketSummary() {
                const now = new Date();
                const dateStr = now.toLocaleDateString('ko-KR', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    weekday: 'long'
                });
                const timeStr = now.toLocaleTimeString('ko-KR', {
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                });

                // 업데이트 시간 표시
                const updateTimeEl = document.getElementById('update-time');
                if (updateTimeEl) {
                    updateTimeEl.textContent = `${dateStr} ${timeStr}`;
                }

                // 시장 데이터 수집
                const getPrice = (id) => {
                    const el = document.getElementById(id);
                    if (!el) return null;
                    const text = el.textContent;
                    const match = text.match(/[\d,]+\.[\d]+/);
                    return match ? parseFloat(match[0].replace(/,/g, '')) : null;
                };

                const getChange = (id) => {
                    const el = document.getElementById(id);
                    if (!el) return null;
                    const text = el.textContent;
                    const match = text.match(/([+-]?[\d.]+)%/);
                    return match ? parseFloat(match[1]) : null;
                };

                const kospiChange = getChange('kospi-live');
                const kosdaqChange = getChange('kosdaq-live');
                const kospiPrice = getPrice('kospi-live');
                const kosdaqPrice = getPrice('kosdaq-live');

                // 시황 분석 생성
                let summary = '';

                if (kospiChange === null || kosdaqChange === null) {
                    summary = `<strong>현재 시점:</strong> ${dateStr} ${timeStr}<br><br>⏰ 시장이 휴장 중이거나 데이터를 불러오는 중입니다. 거래 시간(09:00-15:30)에 다시 확인해주세요.`;
                } else {
                    const avgChange = (kospiChange + kosdaqChange) / 2;
                    let marketTrend = '';
                    let trendEmoji = '';
                    let analysis = '';

                    if (avgChange > 1) {
                        marketTrend = '강세';
                        trendEmoji = '📈🔥';
                        analysis = `KOSPI ${kospiChange > 0 ? '+' : ''}${kospiChange.toFixed(2)}%, KOSDAQ ${kosdaqChange > 0 ? '+' : ''}${kosdaqChange.toFixed(2)}%로 투자 심리가 개선되고 있습니다. 레버리지 ETF를 활용한 공격적 포지션 구축 타이밍이며, 목표가 도달 시 부분 익절을 권장합니다.`;
                    } else if (avgChange > 0.3) {
                        marketTrend = '상승';
                        trendEmoji = '📈';
                        analysis = `KOSPI ${kospiChange > 0 ? '+' : ''}${kospiChange.toFixed(2)}%, KOSDAQ ${kosdaqChange > 0 ? '+' : ''}${kosdaqChange.toFixed(2)}%로 완만한 상승 흐름입니다. 레버리지 50% 내외로 안정적 진입을 추천하며, 급등 시 일부 차익 실현을 고려하세요.`;
                    } else if (avgChange > -0.3) {
                        marketTrend = '혼조';
                        trendEmoji = '📊';
                        analysis = `KOSPI ${kospiChange > 0 ? '+' : ''}${kospiChange.toFixed(2)}%, KOSDAQ ${kosdaqChange > 0 ? '+' : ''}${kosdaqChange.toFixed(2)}%로 방향성이 불분명합니다. 현금 비중을 높게 유지하며 추세 확인 후 진입하고, 단기 변동성에 주의가 필요합니다.`;
                    } else if (avgChange > -1) {
                        marketTrend = '약세';
                        trendEmoji = '📉';
                        analysis = `KOSPI ${kospiChange.toFixed(2)}%, KOSDAQ ${kosdaqChange.toFixed(2)}%로 조정 국면입니다. 레버리지 비중을 30% 이하로 축소하고, 손절 기준을 엄격히 준수하며 방어적 포지션을 유지하세요.`;
                    } else {
                        marketTrend = '급락';
                        trendEmoji = '⚠️📉';
                        analysis = `KOSPI ${kospiChange.toFixed(2)}%, KOSDAQ ${kosdaqChange.toFixed(2)}%로 급격한 하락세입니다. 레버리지 포지션 즉시 청산을 고려하고, 현금 비중 80% 이상 확보하며 반등 시점까지 관망을 권장합니다.`;
                    }

                    summary = `
            <div style="margin-bottom: 16px;">
                <strong style="font-size: 18px;">${trendEmoji} 현재 시장: ${marketTrend}</strong>
                <div style="margin-top: 8px; font-size: 14px; color: rgba(255,255,255,0.8);">
                    ${dateStr} ${timeStr} 기준
                </div>
            </div>
            <div style="line-height: 1.9;">
                ${analysis}
            </div>
        `;
                }

                const summaryEl = document.getElementById('market-summary-content');
                if (summaryEl) {
                    summaryEl.innerHTML = summary;
                }
            }

            // 페이지 로드 시 실행
            window.addEventListener('DOMContentLoaded', () => {
                // 시황 섹션 생성
                initMarketSummary();

                // 초기 업데이트 (2초 후)
                setTimeout(updateMarketSummary, 2000);

                // 30초마다 자동 업데이트
                setInterval(updateMarketSummary, 30000);

                console.log('✅ 실시간 시황 요약 시스템 활성화');
            });
        </script>

</body>

</html>